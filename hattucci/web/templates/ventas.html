<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ventas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="static/css/estilo.css">

  <style>
    /* ======== BOLETA ======== */
    #boletaContainer {
        display: none;
        background: white;
        color: black;
        padding: 20px;
        width: 700px;
        margin: 20px auto;
        border: 2px solid #000;
        font-family: Arial, sans-serif;
    }

    #boletaContainer table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }

    #boletaContainer th, #boletaContainer td {
        border: 1px solid black;
        padding: 6px;
    }

    /* Solo imprimir la boleta */
    @media print {
        body * { visibility: hidden; }
        #boletaContainer, #boletaContainer * { visibility: visible; }
        #boletaContainer {
            position: absolute;
            left: 0; top: 0;
            width: 100%;
        }
    }
  </style>
</head>

<body>
  <div class="d-flex">

    <!-- üî∏ SIDEBAR -->
    <div class="hamburger">‚ò∞</div>
    <nav class="sidebar d-flex flex-column p-3">
      <div class="text-center mt-3 mb-4">
        <h2 class="text-warning">Hattucci Web</h2>
      </div>

      <ul class="nav flex-column flex-grow-1 justify-content-center text-center">
        <li class="nav-item mb-3"><a href="{{ url_for('menu') }}" class="nav-link menu-btn"><span>üè†</span> Men√∫ Principal</a></li>
        <li class="nav-item mb-3"><a href="{{ url_for('compras') }}" class="nav-link menu-btn"><span>üõí</span> Compras</a></li>
        <li class="nav-item mb-3"><a href="{{ url_for('inventario') }}" class="nav-link menu-btn"><span>üì¶</span> Inventario</a></li>
        <li class="nav-item mb-3"><a href="{{ url_for('ventas') }}" class="nav-link menu-btn active"><span>üí∞</span> Ventas</a></li>
        <li class="nav-item mb-3"><a href="{{ url_for('reportes') }}" class="nav-link menu-btn"><span>üìä</span> Reportes</a></li>
      </ul>

      <div class="text-center mb-3 mt-auto">
        <a href="{{ url_for('logout') }}" class="btn btn-danger w-100 py-2">Salir</a>
      </div>
    </nav>

    <!-- üî∏ CONTENIDO -->
    <main class="main-content flex-grow-1 p-4">

      <header class="text-center mb-4">
        <h1 class="text-warning">Gesti√≥n de Ventas</h1>
      </header>

      <!-- FORMULARIO -->
      <section class="form-section mb-4">
        <h2>Registrar Venta</h2>

        <form class="product-form" id="ventaForm">
          <select id="productoSelect" required>
            <option value="">Selecciona un producto</option>
          </select>

          <input type="number" id="cantidad" placeholder="Cantidad" min="1" required>
          <input type="number" id="descuento" placeholder="% Descuento" min="0" max="100">

          <button type="submit">Agregar a venta</button>
        </form>
      </section>

      <!-- TABLA -->
      <section class="table-section">
        <table id="tablaVenta">
          <thead class="table-warning text-dark">
            <tr>
              <th>Producto</th>
              <th>Cantidad</th>
              <th>Precio Unit.</th>
              <th>Descuento</th>
              <th>Total</th>
              <th>Eliminar</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- TOTAL -->
      <div class="total-box mt-3">
        <h3>Total Venta: <span id="totalVenta">S/ 0.00</span></h3>
        <button class="btn btn-success" id="confirmarVenta">Confirmar Venta</button>
      </div>

    </main>
  </div>

  <!-- =================================================
                üìÑ BOLETA CON DESCUENTO Y CORRELATIVO
  ================================================== -->
  <div id="boletaContainer">
      <div style="text-align:center; border-bottom:2px solid #000; padding-bottom:10px;">
          <h2 style="margin:0;">MINIMARKET "HATTUCCI"</h2>
          <p style="margin:0;">RUC: 10701822981</p>
          <p style="margin:0;">Malec√≥n G√°lvez N¬∞628 - Tarma</p>
          <p style="margin:0;">Cel: 913621729</p>
      </div>

      <h3 style="text-align:center; margin-top:10px;">
          BOLETA DE VENTA N¬∞ <span id="b_numero"></span>
      </h3>

      <p><b>Fecha:</b> <span id="b_fecha"></span></p>

      <table>
          <thead>
              <tr style="background:#dcdcdc;">
                  <th>Cant.</th>
                  <th>Descripci√≥n</th>
                  <th>P. Unit</th>
                  <th>Desc.</th>
                  <th>Importe</th>
              </tr>
          </thead>
          <tbody id="b_detalle"></tbody>
      </table>

      <h3 style="text-align:right; margin-top:10px;">
          Total S/: <span id="b_total"></span>
      </h3>
  </div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- ============================================================
                     üî• JAVASCRIPT ACTUALIZADO
=============================================================== -->
<script>
let carrito = [];
let productosInventario = [];

/* ====================== INVENTARIO ====================== */
async function cargarInventario() {
    const res = await fetch("/obtener_inventario");
    productosInventario = await res.json();

    const select = document.getElementById("productoSelect");
    select.innerHTML = `<option value="">Selecciona un producto</option>`;

    productosInventario.forEach(p => {
        select.innerHTML += `
          <option value="${p.id}"
            data-nombre="${p.producto}"
            data-stock="${p.stock}"
            data-precio="${p.precio_venta}">
              ${p.producto} ‚Äî S/ ${p.precio_venta} (${p.stock} uds)
          </option>`;
    });
}

/* ==================== AGREGAR PRODUCTO ==================== */
document.getElementById("ventaForm").addEventListener("submit", function(e) {
    e.preventDefault();

    const opt = productoSelect.selectedOptions[0];
    if (!opt.value) return;

    const id = opt.value;
    const nombre = opt.dataset.nombre;
    const precio = parseFloat(opt.dataset.precio);
    const stock = parseInt(opt.dataset.stock);
    const cantidadValor = parseInt(cantidad.value);
    const descuentoValor = parseInt(descuento.value || 0);

    if (cantidadValor > stock) {
        return Swal.fire("üì¶ Stock insuficiente");
    }

    const total = (precio * cantidadValor) * (1 - descuentoValor / 100);

    carrito.push({ id, nombre, cantidad: cantidadValor, precio, descuento: descuentoValor, total });

    actualizarTablaVenta();
    actualizarTotalVenta();
});

/* ==================== TABLA ==================== */
function actualizarTablaVenta() {
    const tbody = document.querySelector("#tablaVenta tbody");
    tbody.innerHTML = "";

    carrito.forEach((item, index) => {
        tbody.innerHTML += `
            <tr>
                <td>${item.nombre}</td>
                <td>${item.cantidad}</td>
                <td>S/ ${item.precio.toFixed(2)}</td>
                <td>${item.descuento}%</td>
                <td>S/ ${item.total.toFixed(2)}</td>
                <td><button onclick="eliminarItem(${index})" class="btn btn-danger btn-sm">üóë</button></td>
            </tr>`;
    });
}

function eliminarItem(i) {
    carrito.splice(i, 1);
    actualizarTablaVenta();
    actualizarTotalVenta();
}

/* ==================== TOTAL ==================== */
function actualizarTotalVenta() {
    let total = carrito.reduce((sum, i) => sum + i.total, 0);
    document.getElementById("totalVenta").textContent = "S/ " + total.toFixed(2);
}

/* ==================== CONFIRMAR VENTA ==================== */
document.getElementById("confirmarVenta").addEventListener("click", async () => {

    if (carrito.length === 0) {
        return Swal.fire("Carrito vac√≠o");
    }

    const ask = await Swal.fire({
        title: "¬øDesea boleta?",
        showCancelButton: true,
        confirmButtonText: "S√≠",
        cancelButtonText: "No"
    });

    const tipo = ask.isConfirmed ? "BOLETA" : "SIN_COMPROBANTE";

    procesarVenta(tipo);
});

/* ==================== PROCESAR VENTA ==================== */
async function procesarVenta(comprobante) {

    const res = await fetch("/descontar_stock", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ venta: carrito, comprobante })
    });

    const data = await res.json();
    const total = carrito.reduce((s, i) => s + i.total, 0);

    if (!data.ok) return Swal.fire("Error al registrar venta");

    /* === SIN BOLETA === */
    if (comprobante === "SIN_COMPROBANTE") {
        Swal.fire("Venta registrada", `Total S/ ${total.toFixed(2)}`, "success");
        carrito = [];
        actualizarTablaVenta();
        actualizarTotalVenta();
        cargarInventario();
        return;
    }

    /* === GENERAR BOLETA === */
    const correlativo = data.correlativo.padStart(4, "0");

    document.getElementById("b_numero").textContent = correlativo;
    document.getElementById("b_fecha").textContent = new Date().toLocaleDateString();

    let detalle = "";
    carrito.forEach(i => {
        detalle += `
        <tr>
            <td>${i.cantidad}</td>
            <td>${i.nombre}</td>
            <td>S/ ${i.precio.toFixed(2)}</td>
            <td>${i.descuento}%</td>
            <td>S/ ${i.total.toFixed(2)}</td>
        </tr>`;
    });

    document.getElementById("b_detalle").innerHTML = detalle;
    document.getElementById("b_total").textContent = total.toFixed(2);

    document.getElementById("boletaContainer").style.display = "block";

    window.print(); // üñ® auto imprimir / PDF

    document.getElementById("boletaContainer").style.display = "none";

    carrito = [];
    actualizarTablaVenta();
    actualizarTotalVenta();
    cargarInventario();
}

document.addEventListener("DOMContentLoaded", cargarInventario);
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const sidebar = document.querySelector(".sidebar");
    const hamburger = document.querySelector(".hamburger");

    hamburger.addEventListener("click", () => {
        sidebar.classList.toggle("active");
    });
});
</script>

</body>
</html>
