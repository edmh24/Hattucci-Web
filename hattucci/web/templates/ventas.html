<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ventas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="static/css/estilo.css">
</head>

<body>
  <div class="d-flex">

    <!-- üî∏ SIDEBAR -->
    <div class="hamburger">‚ò∞</div>
    <nav class="sidebar d-flex flex-column p-3">
      <div class="text-center mt-3 mb-4">
        <h2 class="text-warning">Hattucci Web</h2>
      </div>

      <ul class="nav flex-column flex-grow-1 justify-content-center text-center">
        <li class="nav-item mb-3"><a href="{{ url_for('menu') }}" class="nav-link menu-btn"><span>üè†</span> Men√∫ Principal</a></li>
        <li class="nav-item mb-3"><a href="{{ url_for('compras') }}" class="nav-link menu-btn"><span>üõí</span> Compras</a></li>
        <li class="nav-item mb-3"><a href="{{ url_for('inventario') }}" class="nav-link menu-btn"><span>üì¶</span> Inventario</a></li>
        <li class="nav-item mb-3"><a href="{{ url_for('ventas') }}" class="nav-link menu-btn active"><span>üí∞</span> Ventas</a></li>
        <li class="nav-item mb-3"><a href="{{ url_for('reportes') }}" class="nav-link menu-btn"><span>üìä</span> Reportes</a></li>
      </ul>

      <div class="text-center mb-3 mt-auto">
        <a href="{{ url_for('logout') }}" class="btn btn-danger w-100 py-2">Salir</a>
      </div>
    </nav>

    <!-- üî∏ CONTENIDO -->
    <main class="main-content flex-grow-1 p-4">

      <header class="text-center mb-4">
        <h1 class="text-warning">Gesti√≥n de Ventas</h1>
      </header>

      <!-- FORMULARIO DE VENTA -->
      <section class="form-section mb-4">
        <h2>Registrar Venta</h2>

        <form class="product-form" id="ventaForm">
          <select id="productoSelect" required>
            <option value="">Selecciona un producto</option>
          </select>

          <input type="number" id="cantidad" placeholder="Cantidad" min="1" required>
          <input type="number" id="descuento" placeholder="% Descuento" min="0" max="100">

          <button type="submit">Agregar a venta</button>
        </form>
      </section>

      <!-- TABLA DE VENTA -->
      <section class="table-section">
        <table id="tablaVenta">
          <thead class="table-warning text-dark">
            <tr>
              <th>Producto</th>
              <th>Cantidad</th>
              <th>Precio Unit.</th>
              <th>Descuento</th>
              <th>Total</th>
              <th>Eliminar</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- TOTAL -->
      <div class="total-box mt-3">
        <h3>Total Venta: <span id="totalVenta">S/ 0.00</span></h3>
        <button class="btn btn-success" id="confirmarVenta">Confirmar Venta</button>
      </div>

    </main>
  </div>

  <!-- SWEETALERT -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- ============================================================
                         üî• JAVASCRIPT COMPLETO
       ============================================================ -->
  <script>

  let productosInventario = [];
  let carrito = [];

  /* ===============================
         CARGAR INVENTARIO
     =============================== */
  async function cargarInventario() {
    const res = await fetch("/obtener_inventario");
    productosInventario = await res.json();

    const select = document.getElementById("productoSelect");
    select.innerHTML = `<option value="">Selecciona un producto</option>`;

    productosInventario.forEach(p => {

      let disable = p.stock <= 0 ? "disabled" : "";

      select.innerHTML += `
        <option value="${p.id}" 
          data-nombre="${p.producto}"
          data-stock="${p.stock}"
          data-precio="${p.precio_venta}"
          data-venc="${p.fecha_vencimiento}"
          ${disable}>
            ${p.producto} ‚Äî S/ ${p.precio_venta} (${p.stock} uds)
        </option>
      `;
    });
  }

  /* ============================================================
          AGREGAR A VENTA
     ============================================================ */
  document.getElementById("ventaForm").addEventListener("submit", function(e) {
    e.preventDefault();

    const opt = productoSelect.selectedOptions[0];
    if (!opt || !opt.value) return;

    const id = opt.value;
    const nombre = opt.dataset.nombre;
    const precio = parseFloat(opt.dataset.precio);
    const stock = parseInt(opt.dataset.stock);
    const venc = opt.dataset.venc;

    // üîß CORRECCI√ìN: obtener valores reales del input
    const cantidadValor = parseInt(document.getElementById("cantidad").value);
    const descuentoValor = parseInt(document.getElementById("descuento").value || 0);

    if (cantidadValor > stock) {
        Swal.fire("üì¶ Stock insuficiente", "No puedes vender m√°s de lo que hay en inventario", "warning");
        return;
    }

    if (venc) {
        const hoy = new Date();
        const fv = new Date(venc);
        const dias = Math.ceil((fv - hoy) / 86400000);

        if (dias <= 7) {
            Swal.fire("‚è≥ Producto por vencer", 
              `El producto vence en ${dias} d√≠as. Puedes aplicar descuento.`, 
              "info");
        }
    }

    const total = (precio * cantidadValor) * (1 - descuentoValor / 100);

    carrito.push({
        id,
        nombre,
        cantidad: cantidadValor,
        precio,
        descuento: descuentoValor,
        total
    });

    actualizarTablaVenta();
    actualizarTotalVenta();

    // limpiar inputs
    document.getElementById("cantidad").value = "";
    document.getElementById("descuento").value = "";
});


  /* ===============================
       ACTUALIZAR TABLA
     =============================== */
  function actualizarTablaVenta() {
    const tbody = document.querySelector("#tablaVenta tbody");
    tbody.innerHTML = "";

    carrito.forEach((item, index) => {
      tbody.innerHTML += `
        <tr>
          <td>${item.nombre}</td>
          <td>${item.cantidad}</td>
          <td>S/ ${item.precio.toFixed(2)}</td>
          <td>${item.descuento}%</td>
          <td>S/ ${item.total.toFixed(2)}</td>
          <td><button class="btn btn-danger btn-sm" onclick="eliminarItem(${index})">üóë</button></td>
        </tr>
      `;
    });
  }

  function eliminarItem(i) {
    carrito.splice(i, 1);
    actualizarTablaVenta();
    actualizarTotalVenta();
  }

  function actualizarTotalVenta() {
    let total = carrito.reduce((sum, item) => sum + item.total, 0);
    document.getElementById("totalVenta").textContent = "S/ " + total.toFixed(2);
  }

  /* ============================================================
      CONFIRMAR VENTA CON COMPROBANTE
     ============================================================ */
  document.getElementById("confirmarVenta").addEventListener("click", async () => {

    if (carrito.length === 0) {
      Swal.fire("Carrito vac√≠o", "Agrega productos antes de confirmar", "warning");
      return;
    }

    // Preguntar si desea comprobante
    const comprobante = await Swal.fire({
        title: "¬øDesea comprobante de pago?",
        icon: "question",
        showCancelButton: true,
        confirmButtonText: "S√≠",
        cancelButtonText: "No",
        confirmButtonColor: "#28a745",
        cancelButtonColor: "#dc3545"
    });

    let tipoComprobante = "SIN_COMPROBANTE";

    if (comprobante.isConfirmed) {
        const tipo = await Swal.fire({
            title: "Seleccione el tipo de comprobante",
            input: "radio",
            inputOptions: {
                boleta: "Boleta",
                boleta_electronica: "Boleta Electr√≥nica",
                factura: "Factura"
            },
            inputValidator: value => !value && "Debe seleccionar una opci√≥n",
            confirmButtonText: "Aceptar"
        });

        tipoComprobante = tipo.value;
    }

    await procesarVenta(tipoComprobante);
  });

  /* ============================================================
      PROCESAR VENTA ‚Üí DESCONTAR STOCK
     ============================================================ */
  async function procesarVenta(tipoComprobante) {
    const res = await fetch("/descontar_stock", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        venta: carrito,
        comprobante: tipoComprobante
      })
    });

    const data = await res.json();

    if (data.ok) {
      Swal.fire({
        title: "Venta registrada",
        html: `
          Total: <b>S/ ${carrito.reduce((s, i) => s + i.total, 0).toFixed(2)}</b><br>
          Comprobante: <b>${tipoComprobante.replace("_", " ")}</b>
        `,
        icon: "success"
      });

      carrito = [];
      actualizarTablaVenta();
      actualizarTotalVenta();
      cargarInventario();
    }
  }

  /* ===============================
        INICIALIZAR
     =============================== */
  document.addEventListener("DOMContentLoaded", cargarInventario);

  </script>

  <script>
document.addEventListener("DOMContentLoaded", () => {
    const sidebar = document.querySelector(".sidebar");
    const hamburger = document.querySelector(".hamburger");

    hamburger.addEventListener("click", () => {
        sidebar.classList.toggle("active");
    });
});
</script>


</body>
</html>
