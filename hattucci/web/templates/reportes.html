<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reportes</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="static/css/estilo.css">

  <style>
    /* ============================
       ESTILO DEL PDF DEL REPORTE
    ============================ */
    #reportePDF {
        display: none;
        background: white;
        color: black;
        padding: 25px;
        width: 800px;
        margin: auto;
        font-family: Arial, sans-serif;
        border: 2px solid black;
    }

    #reportePDF .titulo-seccion {
        background: #F5E81F;  /* Amarillo del logo */
        padding: 8px;
        font-weight: bold;
        border: 1px solid black;
    }

    #reportePDF table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }

    #reportePDF th, #reportePDF td {
        border: 1px solid black;
        padding: 6px;
        text-align: center;
    }

    #reportePDF .header-logo {
        width: 120px;
        margin-bottom: 10px;
    }

    #reportePDF h2, #reportePDF h3 {
        margin: 0;
        padding: 0;
    }

    @media print {
        body * { visibility: hidden !important; }
        #reportePDF, #reportePDF * { visibility: visible !important; }
        #reportePDF { position: absolute; top: 0; left: 0; width: 100% !important; }
    }
  </style>
</head>

<body>
<div class="d-flex vh-100">

  <!-- SIDEBAR -->
  <div class="hamburger">‚ò∞</div>
  <nav class="sidebar d-flex flex-column p-3">
    <div class="text-center mt-3 mb-4">
      <h2 class="text-warning">Hattucci Web</h2>
    </div>

    <ul class="nav flex-column flex-grow-1 justify-content-center text-center">
      <li class="nav-item mb-3"><a href="{{ url_for('menu') }}" class="nav-link menu-btn"><span>üè†</span> Men√∫ Principal</a></li>
      <li class="nav-item mb-3"><a href="{{ url_for('compras') }}" class="nav-link menu-btn"><span>üõí</span> Compras</a></li>
      <li class="nav-item mb-3"><a href="{{ url_for('inventario') }}" class="nav-link menu-btn"><span>üì¶</span> Inventario</a></li>
      <li class="nav-item mb-3"><a href="{{ url_for('ventas') }}" class="nav-link menu-btn"><span>üí∞</span> Ventas</a></li>
      <li class="nav-item mb-3"><a href="{{ url_for('reportes') }}" class="nav-link menu-btn active"><span>üìä</span> Reportes</a></li>
    </ul>

    <div class="text-center mb-3 mt-auto">
      <a href="{{ url_for('logout') }}" class="btn btn-danger w-100 py-2">Salir</a>
    </div>
  </nav>

  <!-- CONTENIDO -->
  <main class="main-content flex-grow-1 p-4">

    <header class="text-center mb-4">
      <h1 class="text-warning">Reportes del D√≠a</h1>
    </header>

    <!-- FILTRO -->
    <section class="form-section mb-4">
      <h2>Filtrar por D√≠a</h2>

      <input type="date" id="fechaFiltro" class="form-control mb-3" style="max-width:300px; margin:auto;">
      <button class="btn btn-warning mt-2" onclick="cargarReportes()">Filtrar</button>

      <button class="btn btn-success mt-3" onclick="generarPDF()">
        üìÑ Generar Reporte en PDF
      </button>
    </section>

    <!-- TABLA DETALLE -->
    <h2>Detalle de Movimientos</h2>

    <table id="tablaReportes">
      <thead>
        <tr>
          <th>Tipo</th>
          <th>Producto</th>
          <th>Cantidad</th>
          <th>Total (S/)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- GANANCIA O P√âRDIDA -->
    <div class="mt-4 text-center">
      <h3 id="balanceDia"></h3>
    </div>

  </main>
</div>


<!-- ===============================
      üìÑ PDF OCULTO PARA IMPRIMIR
================================= -->
<div id="reportePDF">
    <div style="text-align:center;">
        <img src="/static/img/logo.jpg" class="header-logo">
        <h2>REPORTE GENERAL - HATTUCCI</h2>
        <h3 id="pdf_fecha"></h3>
    </div>

    <h3 class="titulo-seccion">MOVIMIENTOS DEL D√çA</h3>
    <table id="pdf_tabla"></table>

    <h3 class="titulo-seccion">RESUMEN</h3>
    <table>
        <tr><td><b>Total Ventas:</b></td><td id="pdf_totalVentas"></td></tr>
        <tr><td><b>Total Compras:</b></td><td id="pdf_totalCompras"></td></tr>
        <tr><td><b>Ganancia / P√©rdida:</b></td><td id="pdf_ganancia"></td></tr>
    </table>
    
</div>


<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
let movimientosGlobal = [];
let resumenGlobal = {};

/* ===============================
       CARGAR REPORTES
=============================== */
async function cargarReportes() {
    const fecha = document.getElementById("fechaFiltro").value;

    if (!fecha) return Swal.fire("Seleccione una fecha");

    const res = await fetch("/obtener_movimientos_dia", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ fecha })
    });

    const data = await res.json();

    movimientosGlobal = data.movimientos;
    resumenGlobal = data;

    actualizarTabla(data.movimientos);
    mostrarBalance(data.ganancia);
}

/* ===============================
         TABLA NORMAL
=============================== */
function actualizarTabla(movs) {
    const tbody = document.querySelector("#tablaReportes tbody");
    tbody.innerHTML = "";

    if (movs.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="text-center">No hay movimientos</td></tr>`;
        return;
    }

    movs.forEach(m => {
        tbody.innerHTML += `
            <tr>
                <td>${m.tipo}</td>
                <td>${m.producto}</td>
                <td>${m.cantidad}</td>
                <td>S/ ${parseFloat(m.total).toFixed(2)}</td>
            </tr>`;
    });
}

function mostrarBalance(ganancia) {
    const b = document.getElementById("balanceDia");

    ganancia = parseFloat(ganancia);

    if (ganancia > 0)
        b.innerHTML = `<span style="color:#00ff55;">üü¢ Ganancia del d√≠a: S/ ${ganancia.toFixed(2)}</span>`;
    else if (ganancia < 0)
        b.innerHTML = `<span style="color:#ff4444;">üî¥ P√©rdida del d√≠a: S/ ${ganancia.toFixed(2)}</span>`;
    else
        b.innerHTML = `<span>No hubo ganancia ni p√©rdida hoy.</span>`;
}

/* ===============================
      üìÑ GENERAR PDF
=============================== */
function generarPDF() {
    if (movimientosGlobal.length === 0)
        return Swal.fire("No hay datos para generar reporte");

    const fecha = document.getElementById("fechaFiltro").value;
    document.getElementById("pdf_fecha").innerText = `Fecha: ${fecha}`;

    let tablaPDF = `
        <tr>
            <th>Tipo</th>
            <th>Producto</th>
            <th>Cantidad</th>
            <th>Total (S/)</th>
        </tr>
    `;

    movimientosGlobal.forEach(m => {
        tablaPDF += `
            <tr>
                <td>${m.tipo}</td>
                <td>${m.producto}</td>
                <td>${m.cantidad}</td>
                <td>S/ ${parseFloat(m.total).toFixed(2)}</td>
            </tr>`;
    });

    document.getElementById("pdf_tabla").innerHTML = tablaPDF;

    document.getElementById("pdf_totalVentas").innerText = "S/ " + resumenGlobal.totalVentas.toFixed(2);
    document.getElementById("pdf_totalCompras").innerText = "S/ " + resumenGlobal.totalCompras.toFixed(2);
    document.getElementById("pdf_ganancia").innerText = "S/ " + resumenGlobal.ganancia.toFixed(2);

    document.getElementById("reportePDF").style.display = "block";
    window.print();
}

document.addEventListener("DOMContentLoaded", () => {
    let hoy = new Date().toISOString().split("T")[0];
    document.getElementById("fechaFiltro").value = hoy;
    cargarReportes();
});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const sidebar = document.querySelector(".sidebar");
    const hamburger = document.querySelector(".hamburger");

    hamburger.addEventListener("click", () => {
        sidebar.classList.toggle("active");
    });
});
</script>

</body>
</html>
