<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reportes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="static/css/estilo.css">
</head>

<body>
<div class="d-flex vh-100">

  <!-- SIDEBAR -->
  <nav class="sidebar d-flex flex-column p-3">
    <div class="text-center mt-3 mb-4">
      <h2 class="text-warning">Hattucci Web</h2>
    </div>

    <ul class="nav flex-column flex-grow-1 justify-content-center text-center">
      <li class="nav-item mb-3"><a href="{{ url_for('menu') }}" class="nav-link menu-btn"><span>üè†</span> Men√∫ Principal</a></li>
      <li class="nav-item mb-3"><a href="{{ url_for('compras') }}" class="nav-link menu-btn"><span>üõí</span> Compras</a></li>
      <li class="nav-item mb-3"><a href="{{ url_for('inventario') }}" class="nav-link menu-btn"><span>üì¶</span> Inventario</a></li>
      <li class="nav-item mb-3"><a href="{{ url_for('ventas') }}" class="nav-link menu-btn"><span>üí∞</span> Ventas</a></li>
      <li class="nav-item mb-3"><a href="{{ url_for('reportes') }}" class="nav-link menu-btn active"><span>üìä</span> Reportes</a></li>
    </ul>

    <div class="text-center mb-3 mt-auto">
      <a href="{{ url_for('logout') }}" class="btn btn-danger w-100 py-2">Salir</a>
    </div>
  </nav>

  <!-- CONTENIDO -->
  <main class="main-content flex-grow-1 p-4">

    <header class="text-center mb-4">
      <h1 class="text-warning">Reportes del D√≠a</h1>
    </header>

    <!-- FILTRO -->
    <section class="form-section mb-4">
      <h2>Filtrar por D√≠a</h2>

      <input type="date" id="fechaFiltro" class="form-control mb-3" style="max-width:300px; margin:auto;">
      <button class="btn btn-warning mt-2" onclick="cargarReportes()">Filtrar</button>
    </section>

    <!-- TABLA DETALLE -->
    <h2>Detalle de Movimientos</h2>

    <table id="tablaReportes">
      <thead>
        <tr>
          <th>Tipo</th>
          <th>Producto</th>
          <th>Cantidad</th>
          <th>Total (S/)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- GANANCIA O P√âRDIDA -->
    <div class="mt-4 text-center">
      <h3 id="balanceDia"></h3>
    </div>

  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- ======================   JAVASCRIPT   ================================ -->
<script>

async function cargarReportes() {
    const fecha = document.getElementById("fechaFiltro").value;

    if (!fecha) {
        Swal.fire("Seleccione una fecha", "", "warning");
        return;
    }

    const res = await fetch("/obtener_movimientos_dia", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ fecha })
    });

    const data = await res.json();

    actualizarTabla(data.movimientos);
    mostrarBalance(data.ganancia, data.totalVentas, data.totalCompras);
}

function actualizarTabla(movs) {
    const tbody = document.querySelector("#tablaReportes tbody");
    tbody.innerHTML = "";

    if (movs.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">No hay movimientos</td></tr>`;
        return;
    }

    movs.forEach(m => {
        tbody.innerHTML += `
            <tr>
                <td>${m.tipo}</td>
                <td>${m.producto}</td>
                <td>${m.cantidad}</td>
                <td>S/ ${m.total.toFixed(2)}</td>
            </tr>
        `;
    });
}

function mostrarBalance(ganancia, totalVentas, totalCompras) {
    const balance = document.getElementById("balanceDia");

    if (ganancia > 0) {
        balance.innerHTML = `
        <span style="color:#00ff55;">
            üü¢ Ganancia del d√≠a: S/ ${ganancia.toFixed(2)}
        </span>
        `;
    } else if (ganancia < 0) {
        balance.innerHTML = `
        <span style="color:#ff4444;">
            üî¥ P√©rdida del d√≠a: S/ ${ganancia.toFixed(2)}
        </span>
        `;
    } else {
        balance.innerHTML = `
        <span style="color:#fff;">
            No hubo ganancia ni p√©rdida hoy.
        </span>
        `;
    }
}

document.addEventListener("DOMContentLoaded", () => {
    let hoy = new Date().toISOString().split("T")[0];
    document.getElementById("fechaFiltro").value = hoy;
    cargarReportes();
});

</script>

</body>
</html>
